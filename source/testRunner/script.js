"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.runTest = runTest;exports.subprocessInspector = subprocessInspector;var _path = _interopRequireDefault(require("path"));
var _assert = _interopRequireDefault(require("assert"));
var _listFileRecursively = require("../utility/listFileRecursively.js");

var _nodejsLiveReload = require("@dependency/nodejsLiveReload");

var _child_process = _interopRequireDefault(require("child_process"));const mochaModule = _path.default.join(__dirname, '../../entrypoint/cli/index.js');

async function runTest({
  targetProject,
  testPath = [],
  jsPath = [],
  jsFileExtension = ['.js', '.ts'],
  testFileExtension = ['.test.js'],
  ignoreRegex = [],
  shouldCompileTest,
  shouldDebugger = false } =
{}) {
  process.on('SIGINT', () => {
    console.log('Caught interrupt signal - test container level');
    process.exit(0);
  });
  console.log(`\x1b[33m\x1b[1m\x1b[7m\x1b[36m%s\x1b[0m \x1b[2m\x1b[3m%s\x1b[0m`, `Container:`, `NodeJS App`);

  await require('@dependency/addModuleResolutionPath').addModuleResolutionPath({ pathArray: [_path.default.dirname(require.main.filename)] });

  (0, _assert.default)(targetProject, `targetProject must be passed.`);
  let targetProjectRootPath = targetProject.configuration.rootPath;


  if (ignoreRegex.length != 0) {
    ignoreRegex.push(new RegExp(`${_path.default.join(targetProjectRootPath, 'temporary')}`));
    ignoreRegex.push(new RegExp(`${_path.default.join(targetProjectRootPath, 'distribution')}`));
  }


  console.log(`• Searching for ${JSON.stringify(testFileExtension)} extension files, in path ${JSON.stringify(testPath)}.`);
  let testFileArray = [];
  testPath.forEach(p => {
    p = !_path.default.isAbsolute(p) ? _path.default.join(targetProjectRootPath, p) : p;
    console.log(`• Test path: ${p}`);
    if (testFileExtension.some(extension => p.endsWith(extension))) {

      testFileArray.push(p);
    } else {

      let fileList = (0, _listFileRecursively.listFileWithExtension)({ directory: p, extension: testFileExtension });
      testFileArray = Array.prototype.concat.apply(testFileArray, fileList);
    }
  });



  jsPath.push(targetProjectRootPath);
  let jsFileArray = jsPath.map(pathArray => (0, _listFileRecursively.listFileWithExtension)({ directory: pathArray, extension: jsFileExtension, ignoreRegex }));
  let jsFileArrayOfArray = Array.prototype.concat.apply(jsFileArray, testFileArray);

  let subprocess;
  function runMochaInSubprocess() {
    let stringifyArgs = JSON.stringify([{ testTarget: testFileArray, jsFileArray: jsFileArrayOfArray, shouldCompileTest, shouldDebugger, targetProject }]);

    subprocess = _child_process.default.fork(mochaModule, [stringifyArgs], {
      stdio: [0, 1, 2, 'ipc'],
      execArgv: [

      '--no-lazy'] });



  }

  await (0, _nodejsLiveReload.watchFile)({

    triggerCallback: () => {
      subprocess && subprocess.kill('SIGINT');
      runMochaInSubprocess();
    },
    fileArray: Array.prototype.concat.apply([testFileArray], jsFileArrayOfArray),
    ignoreNodeModules: true,
    logMessage: false });


  runMochaInSubprocess();
}









function subprocessInspector({ port = 9229, host = 'localhost', shouldbreak = true } = {}) {
  const inspector = require('inspector');
  inspector.open(port, host, shouldbreak);

  process.on('beforeExit', () => {
    setTimeout(() => {}, 1000000000);
  });
  return inspector;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS90ZXN0UnVubmVyL3NjcmlwdC5qcyJdLCJuYW1lcyI6WyJtb2NoYU1vZHVsZSIsInBhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwicnVuVGVzdCIsInRhcmdldFByb2plY3QiLCJ0ZXN0UGF0aCIsImpzUGF0aCIsImpzRmlsZUV4dGVuc2lvbiIsInRlc3RGaWxlRXh0ZW5zaW9uIiwiaWdub3JlUmVnZXgiLCJzaG91bGRDb21waWxlVGVzdCIsInNob3VsZERlYnVnZ2VyIiwicHJvY2VzcyIsIm9uIiwiY29uc29sZSIsImxvZyIsImV4aXQiLCJyZXF1aXJlIiwiYWRkTW9kdWxlUmVzb2x1dGlvblBhdGgiLCJwYXRoQXJyYXkiLCJkaXJuYW1lIiwibWFpbiIsImZpbGVuYW1lIiwidGFyZ2V0UHJvamVjdFJvb3RQYXRoIiwiY29uZmlndXJhdGlvbiIsInJvb3RQYXRoIiwibGVuZ3RoIiwicHVzaCIsIlJlZ0V4cCIsIkpTT04iLCJzdHJpbmdpZnkiLCJ0ZXN0RmlsZUFycmF5IiwiZm9yRWFjaCIsInAiLCJpc0Fic29sdXRlIiwic29tZSIsImV4dGVuc2lvbiIsImVuZHNXaXRoIiwiZmlsZUxpc3QiLCJkaXJlY3RvcnkiLCJBcnJheSIsInByb3RvdHlwZSIsImNvbmNhdCIsImFwcGx5IiwianNGaWxlQXJyYXkiLCJtYXAiLCJqc0ZpbGVBcnJheU9mQXJyYXkiLCJzdWJwcm9jZXNzIiwicnVuTW9jaGFJblN1YnByb2Nlc3MiLCJzdHJpbmdpZnlBcmdzIiwidGVzdFRhcmdldCIsImNoaWxkUHJvY2VzcyIsImZvcmsiLCJzdGRpbyIsImV4ZWNBcmd2IiwidHJpZ2dlckNhbGxiYWNrIiwia2lsbCIsImZpbGVBcnJheSIsImlnbm9yZU5vZGVNb2R1bGVzIiwibG9nTWVzc2FnZSIsInN1YnByb2Nlc3NJbnNwZWN0b3IiLCJwb3J0IiwiaG9zdCIsInNob3VsZGJyZWFrIiwiaW5zcGVjdG9yIiwib3BlbiIsInNldFRpbWVvdXQiXSwibWFwcGluZ3Mi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QUF1QkMsS0FBdkIsQ0FBNkIsQ0FBQ1osYUFBRCxDQUE3QixFQUE4Q2Usa0JBQTlDLENBTkc7QUFPZFksSUFBQUEsaUJBQWlCLEVBQUUsSUFQTDtBQVFkQyxJQUFBQSxVQUFVLEVBQUUsS0FSRSxFQUFWLENBQU47OztBQVdBWCxFQUFBQSxvQkFBb0I7QUFDckI7Ozs7Ozs7Ozs7QUFVTSxTQUFTWSxtQkFBVCxDQUE2QixFQUFFQyxJQUFJLEdBQUcsSUFBVCxFQUFlQyxJQUFJLEdBQUcsV0FBdEIsRUFBbUNDLFdBQVcsR0FBRyxJQUFqRCxLQUEwRCxFQUF2RixFQUEyRjtBQUNoRyxRQUFNQyxTQUFTLEdBQUcvQyxPQUFPLENBQUMsV0FBRCxDQUF6QjtBQUNBK0MsRUFBQUEsU0FBUyxDQUFDQyxJQUFWLENBQWVKLElBQWYsRUFBcUJDLElBQXJCLEVBQTJCQyxXQUEzQjs7QUFFQW5ELEVBQUFBLE9BQU8sQ0FBQ0MsRUFBUixDQUFXLFlBQVgsRUFBeUIsTUFBTTtBQUM3QnFELElBQUFBLFVBQVUsQ0FBQyxNQUFNLENBQUUsQ0FBVCxFQUFXLFVBQVgsQ0FBVjtBQUNELEdBRkQ7QUFHQSxTQUFPRixTQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IGFzc2VydCBmcm9tICdhc3NlcnQnXG5pbXBvcnQgeyBsaXN0RmlsZVJlY3Vyc2l2ZWx5LCBsaXN0RmlsZVdpdGhFeHRlbnNpb24gfSBmcm9tICcuLi91dGlsaXR5L2xpc3RGaWxlUmVjdXJzaXZlbHkuanMnXG5jb25zdCBtb2NoYU1vZHVsZSA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9lbnRyeXBvaW50L2NsaS9pbmRleC5qcycpIC8vIG1vY2hhIGNsaSBmb3IgcnVubmluZyB1c2luZyBub2RlanMgc3Bhd24gY2hpbGQgcHJvY2VzcyBpbnRlcmZhY2UgKGFjY2VwdGluZyBvbmx5IG1vZHVsZSBwYXRocylcbmltcG9ydCB7IHdhdGNoRmlsZSB9IGZyb20gJ0BkZXBlbmRlbmN5L25vZGVqc0xpdmVSZWxvYWQnXG5pbXBvcnQgeyBwcm9taXNlcyBhcyBmaWxlc3lzdGVtIH0gZnJvbSAnZnMnXG5pbXBvcnQgY2hpbGRQcm9jZXNzIGZyb20gJ2NoaWxkX3Byb2Nlc3MnXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBydW5UZXN0KHtcbiAgdGFyZ2V0UHJvamVjdCwgLy8gYFByb2plY3QgY2xhc3NgIGluc3RhbmNlIGNyZWF0ZWQgYnkgYHNjcmlwdE1hbmFnZXJgIGZyb20gdGhlIGNvbmZpZ3VyYXRpb24gZmlsZSBvZiB0aGUgdGFyZ2V0IHByb2plY3QuXG4gIHRlc3RQYXRoID0gW10sIC8vIHJlbGF0aXZlIG9yIGFic29sdXRlXG4gIGpzUGF0aCA9IFtdLFxuICBqc0ZpbGVFeHRlbnNpb24gPSBbJy5qcycsICcudHMnXSxcbiAgdGVzdEZpbGVFeHRlbnNpb24gPSBbJy50ZXN0LmpzJ10sXG4gIGlnbm9yZVJlZ2V4ID0gW10sXG4gIHNob3VsZENvbXBpbGVUZXN0LFxuICBzaG91bGREZWJ1Z2dlciA9IGZhbHNlLCAvLyBydW4gaXNwZWN0b3IgZHVyaW5nIHJ1bnRpbWUuXG59ID0ge30pIHtcbiAgcHJvY2Vzcy5vbignU0lHSU5UJywgKCkgPT4ge1xuICAgIGNvbnNvbGUubG9nKCdDYXVnaHQgaW50ZXJydXB0IHNpZ25hbCAtIHRlc3QgY29udGFpbmVyIGxldmVsJylcbiAgICBwcm9jZXNzLmV4aXQoMClcbiAgfSlcbiAgY29uc29sZS5sb2coYFxceDFiWzMzbVxceDFiWzFtXFx4MWJbN21cXHgxYlszNm0lc1xceDFiWzBtIFxceDFiWzJtXFx4MWJbM20lc1xceDFiWzBtYCwgYENvbnRhaW5lcjpgLCBgTm9kZUpTIEFwcGApXG4gIC8vIFNldHVwIGVudmlyb25tZW50XG4gIGF3YWl0IHJlcXVpcmUoJ0BkZXBlbmRlbmN5L2FkZE1vZHVsZVJlc29sdXRpb25QYXRoJykuYWRkTW9kdWxlUmVzb2x1dGlvblBhdGgoeyBwYXRoQXJyYXk6IFtwYXRoLmRpcm5hbWUocmVxdWlyZS5tYWluLmZpbGVuYW1lKV0gfSlcblxuICBhc3NlcnQodGFyZ2V0UHJvamVjdCwgYHRhcmdldFByb2plY3QgbXVzdCBiZSBwYXNzZWQuYClcbiAgbGV0IHRhcmdldFByb2plY3RSb290UGF0aCA9IHRhcmdldFByb2plY3QuY29uZmlndXJhdGlvbi5yb290UGF0aFxuXG4gIC8vIGlnbm9yZSB0ZW1wb3JhcnkgdHJhbnNwaWxhdGlvbiBmaWxlcyB0byBwcmV2ZW50IHdhdGNoIGV2ZW50IGVtaXNzaW9uIGxvb3Agd2hlbiBpbnNwZWN0b3IgZGVidWdnaW5nIGFuZCBhdXRvIGF0dGFjaCBmb3IgZGVidWdnZXIuXG4gIGlmIChpZ25vcmVSZWdleC5sZW5ndGggIT0gMCkge1xuICAgIGlnbm9yZVJlZ2V4LnB1c2gobmV3IFJlZ0V4cChgJHtwYXRoLmpvaW4odGFyZ2V0UHJvamVjdFJvb3RQYXRoLCAndGVtcG9yYXJ5Jyl9YCkpXG4gICAgaWdub3JlUmVnZXgucHVzaChuZXcgUmVnRXhwKGAke3BhdGguam9pbih0YXJnZXRQcm9qZWN0Um9vdFBhdGgsICdkaXN0cmlidXRpb24nKX1gKSlcbiAgfVxuXG4gIC8qIExpc3QgYWxsIGZpbGVzIGluIGEgZGlyZWN0b3J5IHJlY3Vyc2l2ZWx5ICovXG4gIGNvbnNvbGUubG9nKGDigKIgU2VhcmNoaW5nIGZvciAke0pTT04uc3RyaW5naWZ5KHRlc3RGaWxlRXh0ZW5zaW9uKX0gZXh0ZW5zaW9uIGZpbGVzLCBpbiBwYXRoICR7SlNPTi5zdHJpbmdpZnkodGVzdFBhdGgpfS5gKVxuICBsZXQgdGVzdEZpbGVBcnJheSA9IFtdXG4gIHRlc3RQYXRoLmZvckVhY2gocCA9PiB7XG4gICAgcCA9ICFwYXRoLmlzQWJzb2x1dGUocCkgPyBwYXRoLmpvaW4odGFyZ2V0UHJvamVjdFJvb3RQYXRoLCBwKSA6IHAgLy8gcmVzb2x2ZSB0byBhYnNvbHV0ZSBwYXRoXG4gICAgY29uc29sZS5sb2coYOKAoiBUZXN0IHBhdGg6ICR7cH1gKVxuICAgIGlmICh0ZXN0RmlsZUV4dGVuc2lvbi5zb21lKGV4dGVuc2lvbiA9PiBwLmVuZHNXaXRoKGV4dGVuc2lvbikpKSB7XG4gICAgICAvLyBmaWxlIHBhdGhcbiAgICAgIHRlc3RGaWxlQXJyYXkucHVzaChwKVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBkaXJlY3RvcnkgcGF0aFxuICAgICAgbGV0IGZpbGVMaXN0ID0gbGlzdEZpbGVXaXRoRXh0ZW5zaW9uKHsgZGlyZWN0b3J5OiBwLCBleHRlbnNpb246IHRlc3RGaWxlRXh0ZW5zaW9uIH0pXG4gICAgICB0ZXN0RmlsZUFycmF5ID0gQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseSh0ZXN0RmlsZUFycmF5LCBmaWxlTGlzdClcbiAgICB9XG4gIH0pXG5cbiAgLy8gYXdhaXQgZmlsZXN5c3RlbS5sc3RhdChmaWxlUGF0aCkudGhlbihzdGF0T2JqZWN0ID0+IHN0YXRPYmplY3QuaXNEaXJlY3RvcnkoKSkgLy8gY2hlY2sgaWYgcGF0aCBpcyBhIGRpcmVjdG9yeVxuXG4gIGpzUGF0aC5wdXNoKHRhcmdldFByb2plY3RSb290UGF0aClcbiAgbGV0IGpzRmlsZUFycmF5ID0ganNQYXRoLm1hcChwYXRoQXJyYXkgPT4gbGlzdEZpbGVXaXRoRXh0ZW5zaW9uKHsgZGlyZWN0b3J5OiBwYXRoQXJyYXksIGV4dGVuc2lvbjoganNGaWxlRXh0ZW5zaW9uLCBpZ25vcmVSZWdleCB9KSlcbiAgbGV0IGpzRmlsZUFycmF5T2ZBcnJheSA9IEFycmF5LnByb3RvdHlwZS5jb25jYXQuYXBwbHkoanNGaWxlQXJyYXksIHRlc3RGaWxlQXJyYXkpXG5cbiAgbGV0IHN1YnByb2Nlc3MgLy8gc3VicHJvY2VzcyByZWZlcmVuY2UgdG8gY29udHJvbCB0ZXJtaW5hdGlvbi5cbiAgZnVuY3Rpb24gcnVuTW9jaGFJblN1YnByb2Nlc3MoKSB7XG4gICAgbGV0IHN0cmluZ2lmeUFyZ3MgPSBKU09OLnN0cmluZ2lmeShbeyB0ZXN0VGFyZ2V0OiB0ZXN0RmlsZUFycmF5LCBqc0ZpbGVBcnJheToganNGaWxlQXJyYXlPZkFycmF5LCBzaG91bGRDb21waWxlVGVzdCwgc2hvdWxkRGVidWdnZXIsIHRhcmdldFByb2plY3QgfV0pIC8vIHBhcmFtZXRycyBmb3IgbW9jaGEgbW9kdWxlLlxuICAgIC8vIHJ1bm5pbmcgaW4gc3VicHJvY2VzcyBwcmV2ZW50cyBjb25mbGljdHMgYmV0d2VlbiB0ZXN0cyBhbmQgYWxsb3dzIHRvIGNvbnRyb2wgdGhlIHRlc3QgYW5kIHRlcm1pbmF0ZSBpdCB3aGVuIG5lZWRlZC5cbiAgICBzdWJwcm9jZXNzID0gY2hpbGRQcm9jZXNzLmZvcmsobW9jaGFNb2R1bGUsIFtzdHJpbmdpZnlBcmdzXSwge1xuICAgICAgc3RkaW86IFswLCAxLCAyLCAnaXBjJ10sXG4gICAgICBleGVjQXJndjogW1xuICAgICAgICAvLyAnLS1pbnNwZWN0LWJyaz0xMjcyJywgLy8gaW5zcGVjdCBzdWJwcm9jZXNzIHdpdGggcmFuZG9tIHBvcnQgdG8gcHJldmVudCBjb25mbGljdHMgd2l0aCB0aGUgbWFpbiBwcm9jZXNzIGluIGNhc2UgaXQncyBpbnNwZWN0IGZsYWcgd2FzIHR1cm5lZCBvbi5cbiAgICAgICAgJy0tbm8tbGF6eScsIC8vIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMgd2lsbCBsb2FkIG1vZHVsZXMgc2VxdWVudGlhbGx5XG4gICAgICBdLFxuICAgIH0pXG4gICAgLy8gc3VicHJvY2Vzcy5vbignZXhpdCcsICgpID0+IGNvbnNvbGUubG9nKGBUZXN0IHN1YnByb2Nlc3MgJHtzdWJwcm9jZXNzLnBpZH0gZXhpdGVkLmApKTtcbiAgfVxuXG4gIGF3YWl0IHdhdGNoRmlsZSh7XG4gICAgLy8gdG8gYmUgcnVuIGFmdGVyIGZpbGUgbm90aWZpY2F0aW9uXG4gICAgdHJpZ2dlckNhbGxiYWNrOiAoKSA9PiB7XG4gICAgICBzdWJwcm9jZXNzICYmIHN1YnByb2Nlc3Mua2lsbCgnU0lHSU5UJylcbiAgICAgIHJ1bk1vY2hhSW5TdWJwcm9jZXNzKClcbiAgICB9LFxuICAgIGZpbGVBcnJheTogQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseShbdGVzdEZpbGVBcnJheV0sIGpzRmlsZUFycmF5T2ZBcnJheSksIC8vIGFkZCBub2RlX21vZHVsZXMganMgZmlsZXNcbiAgICBpZ25vcmVOb2RlTW9kdWxlczogdHJ1ZSxcbiAgICBsb2dNZXNzYWdlOiBmYWxzZSxcbiAgfSlcblxuICBydW5Nb2NoYUluU3VicHJvY2VzcygpIC8vIGluaXRpYWwgdHJpZ2dlciBhY3Rpb24sIHRvIHJ1biB0ZXN0IGltbWVkaWF0ZWx5XG59XG5cbi8qKlxuICogQWxsb3dzIHRvIHVzZSBOb2RlanMgaW5zcGVjdG9yIHdpdGggdGhlIGN1cnJlbnQgd2F5IHRlc3RzIGFyZSBydW4sIHdoZXJlIHRlc3RzIGFyZSBydW4gaW4gc3VicHJvY2Vzc2VzIGFuZCBubyBOb2RlanMgZmxhZ3MgYXJlIHBhc3NlZC5cbiAqIEN1cnJlbnRseSBpdHMgcG9zc2libGUgdG8gdXNlIGluc3BlY3RvciBwcm9ncmFtbWF0aWMgQVBJLCBidXQgdG8gYWxsb3cgbGl2ZXJlbG9hZCBlYWNoIHRlc3Qgc3VicHJvY2VzcyBzaG91bGQgYmUga2VwdCBhbGl2ZSBlLmcuIHVzaW5nIGBzZXRUaW1lb3V0YCB0byBhbGxvdyBmb3IgaW5zcGVjdGluZyBvYmplY3QgdmFsdWVzIGV0Yy5cbiAqIFVzYWdlOlxuICogIC0gZXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIGluIHRoZSB0b3Agb2YgYSB0ZXN0LlxuICogIC0gaW5zZXJ0IGBkZWJ1Z2dlcmAgc3RhdGVtZW50IGluIHRoZSB0ZXN0IGZpbGVzIHRvIGJyZWFrIGFmdGVyIHJlZnJlc2hpbmcgcHJvY2Vzcy5cbiAqXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzdWJwcm9jZXNzSW5zcGVjdG9yKHsgcG9ydCA9IDkyMjksIGhvc3QgPSAnbG9jYWxob3N0Jywgc2hvdWxkYnJlYWsgPSB0cnVlIH0gPSB7fSkge1xuICBjb25zdCBpbnNwZWN0b3IgPSByZXF1aXJlKCdpbnNwZWN0b3InKVxuICBpbnNwZWN0b3Iub3Blbihwb3J0LCBob3N0LCBzaG91bGRicmVhaylcbiAgLy8gS2VlcCBOb2RlIGFsaXZlIHRvIGFsbG93IGZvciBpbnNwZWN0aW5nIG9iamVjdHMuXG4gIHByb2Nlc3Mub24oJ2JlZm9yZUV4aXQnLCAoKSA9PiB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7fSwgMTAwMDAwMDAwMClcbiAgfSlcbiAgcmV0dXJuIGluc3BlY3RvclxufVxuIl19