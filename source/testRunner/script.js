"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.runTest = runTest;exports.subprocessInspector = subprocessInspector;var _path = _interopRequireDefault(require("path"));


var _child_process = _interopRequireDefault(require("child_process"));const mochaModule = _path.default.join(__dirname, '../../entrypoint/cli/index.js');



async function runTest({
  targetProject = function (e) {throw e;}(new Error('targetProject must be passed.')),
  shouldCompileTest,
  shouldDebugger = false,
  testFileArray,
  jsFileArray,
  watchFile = false } =
{}) {
  console.log(`\x1b[33m\x1b[1m\x1b[7m\x1b[36m%s\x1b[0m \x1b[2m\x1b[3m%s\x1b[0m`, `Container:`, `NodeJS App`);

  await require('@dependency/addModuleResolutionPath').addModuleResolutionPath({ pathArray: [_path.default.dirname(require.main.filename)] });

  let subprocess;

  process.on('SIGINT', () => {
    subprocess && subprocess.kill('SIGINT');
    console.log('Caught interrupt signal') && process.exit(0);
  });
  function runMochaInSubprocess() {
    let stringifyArgs = JSON.stringify([{ testTarget: testFileArray, jsFileArray, shouldCompileTest, shouldDebugger, targetProject }]);

    subprocess = _child_process.default.fork(mochaModule, [stringifyArgs], {
      stdio: [0, 1, 2, 'ipc'],
      execArgv: [

      '--no-lazy'] });


    subprocess.on('exit', () => console.log(`Test subprocess ${subprocess.pid} exited.`));
  }

  runMochaInSubprocess();


  function restartMochaSubprocess() {
    console.log('â€¢ Triggered mocha test restart [javascriptTestRunner]');
    subprocess && subprocess.kill('SIGINT') && runMochaInSubprocess();
  }

  if (watchFile)
  await watchFile({

    triggerCallback: restartMochaSubprocess,

    fileArray: jsFileArray,
    ignoreNodeModules: true,
    logMessage: true });



  return { restart: restartMochaSubprocess };
}









function subprocessInspector({ port = 9229, host = 'localhost', shouldbreak = true } = {}) {
  const inspector = require('inspector');
  inspector.open(port, host, shouldbreak);

  process.on('beforeExit', () => {
    setTimeout(() => {}, 1000000000);
  });
  return inspector;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS90ZXN0UnVubmVyL3NjcmlwdC5qcyJdLCJuYW1lcyI6WyJtb2NoYU1vZHVsZSIsInBhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwicnVuVGVzdCIsInRhcmdldFByb2plY3QiLCJFcnJvciIsInNob3VsZENvbXBpbGVUZXN0Iiwic2hvdWxkRGVidWdnZXIiLCJ0ZXN0RmlsZUFycmF5IiwianNGaWxlQXJyYXkiLCJ3YXRjaEZpbGUiLCJjb25zb2xlIiwibG9nIiwicmVxdWlyZSIsImFkZE1vZHVsZVJlc29sdXRpb25QYXRoIiwicGF0aEFycmF5IiwiZGlybmFtZSIsIm1haW4iLCJmaWxlbmFtZSIsInN1YnByb2Nlc3MiLCJwcm9jZXNzIiwib24iLCJraWxsIiwiZXhpdCIsInJ1bk1vY2hhSW5TdWJwcm9jZXNzIiwic3RyaW5naWZ5QXJncyIsIkpTT04iLCJzdHJpbmdpZnkiLCJ0ZXN0VGFyZ2V0IiwiY2hpbGRQcm9jZXNzIiwiZm9yayIsInN0ZGlvIiwiZXhlY0FyZ3YiLCJwaWQiLCJyZXN0YXJ0TW9jaGFTdWJwcm9jZXNzIiwidHJpZ2dlckNhbGxiYWNrIiwiZmlsZUFycmF5IiwiaWdub3JlTm9kZU1vZHVsZXMiLCJsb2dNZXNzYWdlIiwicmVzdGFydCIsInN1YnByb2Nlc3NJbnNwZWN0b3IiLCJwb3J0IiwiaG9zdCIsInNob3VsZGJyZWFrIiwiaW5zcGVjdG9yIiwib3BlbiIsInNldFRpbWVvdXQiXSwibWFwcGluZ3MiOiI0T0FBQTs7O0FBR0Esc0VBREEsTUFBTUEsV0FBVyxHQUFHQyxjQUFLQyxJQUFMLENBQVVDLFNBQVYsRUFBcUIsK0JBQXJCLENBQXBCOzs7O0FBS08sZUFBZUMsT0FBZixDQUF1QjtBQUM1QkMsRUFBQUEsYUFBYSwyQkFBUyxJQUFJQyxLQUFKLENBQVUsK0JBQVYsQ0FBVCxDQURlO0FBRTVCQyxFQUFBQSxpQkFGNEI7QUFHNUJDLEVBQUFBLGNBQWMsR0FBRyxLQUhXO0FBSTVCQyxFQUFBQSxhQUo0QjtBQUs1QkMsRUFBQUEsV0FMNEI7QUFNNUJDLEVBQUFBLFNBQVMsR0FBRyxLQU5nQjtBQU8xQixFQVBHLEVBT0M7QUFDTkMsRUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsaUVBQWIsRUFBZ0YsWUFBaEYsRUFBOEYsWUFBOUY7O0FBRUEsUUFBTUMsT0FBTyxDQUFDLHFDQUFELENBQVAsQ0FBK0NDLHVCQUEvQyxDQUF1RSxFQUFFQyxTQUFTLEVBQUUsQ0FBQ2YsY0FBS2dCLE9BQUwsQ0FBYUgsT0FBTyxDQUFDSSxJQUFSLENBQWFDLFFBQTFCLENBQUQsQ0FBYixFQUF2RSxDQUFOOztBQUVBLE1BQUlDLFVBQUo7O0FBRUFDLEVBQUFBLE9BQU8sQ0FBQ0MsRUFBUixDQUFXLFFBQVgsRUFBcUIsTUFBTTtBQUN6QkYsSUFBQUEsVUFBVSxJQUFJQSxVQUFVLENBQUNHLElBQVgsQ0FBZ0IsUUFBaEIsQ0FBZDtBQUNBWCxJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSx5QkFBWixLQUEwQ1EsT0FBTyxDQUFDRyxJQUFSLENBQWEsQ0FBYixDQUExQztBQUNELEdBSEQ7QUFJQSxXQUFTQyxvQkFBVCxHQUFnQztBQUM5QixRQUFJQyxhQUFhLEdBQUdDLElBQUksQ0FBQ0MsU0FBTCxDQUFlLENBQUMsRUFBRUMsVUFBVSxFQUFFcEIsYUFBZCxFQUE2QkMsV0FBN0IsRUFBMENILGlCQUExQyxFQUE2REMsY0FBN0QsRUFBNkVILGFBQTdFLEVBQUQsQ0FBZixDQUFwQjs7QUFFQWUsSUFBQUEsVUFBVSxHQUFHVSx1QkFBYUMsSUFBYixDQUFrQi9CLFdBQWxCLEVBQStCLENBQUMwQixhQUFELENBQS9CLEVBQWdEO0FBQzNETSxNQUFBQSxLQUFLLEVBQUUsQ0FBQyxDQUFELEVBQUksQ0FBSixFQUFPLENBQVAsRUFBVSxLQUFWLENBRG9EO0FBRTNEQyxNQUFBQSxRQUFRLEVBQUU7O0FBRVIsaUJBRlEsQ0FGaUQsRUFBaEQsQ0FBYjs7O0FBT0FiLElBQUFBLFVBQVUsQ0FBQ0UsRUFBWCxDQUFjLE1BQWQsRUFBc0IsTUFBTVYsT0FBTyxDQUFDQyxHQUFSLENBQWEsbUJBQWtCTyxVQUFVLENBQUNjLEdBQUksVUFBOUMsQ0FBNUI7QUFDRDs7QUFFRFQsRUFBQUEsb0JBQW9COzs7QUFHcEIsV0FBU1Usc0JBQVQsR0FBa0M7QUFDaEN2QixJQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSx1REFBWjtBQUNBTyxJQUFBQSxVQUFVLElBQUlBLFVBQVUsQ0FBQ0csSUFBWCxDQUFnQixRQUFoQixDQUFkLElBQTJDRSxvQkFBb0IsRUFBL0Q7QUFDRDs7QUFFRCxNQUFJZCxTQUFKO0FBQ0UsUUFBTUEsU0FBUyxDQUFDOztBQUVkeUIsSUFBQUEsZUFBZSxFQUFFRCxzQkFGSDs7QUFJZEUsSUFBQUEsU0FBUyxFQUFFM0IsV0FKRztBQUtkNEIsSUFBQUEsaUJBQWlCLEVBQUUsSUFMTDtBQU1kQyxJQUFBQSxVQUFVLEVBQUUsSUFORSxFQUFELENBQWY7Ozs7QUFVRixTQUFPLEVBQUVDLE9BQU8sRUFBRUwsc0JBQVgsRUFBUDtBQUNEOzs7Ozs7Ozs7O0FBVU0sU0FBU00sbUJBQVQsQ0FBNkIsRUFBRUMsSUFBSSxHQUFHLElBQVQsRUFBZUMsSUFBSSxHQUFHLFdBQXRCLEVBQW1DQyxXQUFXLEdBQUcsSUFBakQsS0FBMEQsRUFBdkYsRUFBMkY7QUFDaEcsUUFBTUMsU0FBUyxHQUFHL0IsT0FBTyxDQUFDLFdBQUQsQ0FBekI7QUFDQStCLEVBQUFBLFNBQVMsQ0FBQ0MsSUFBVixDQUFlSixJQUFmLEVBQXFCQyxJQUFyQixFQUEyQkMsV0FBM0I7O0FBRUF2QixFQUFBQSxPQUFPLENBQUNDLEVBQVIsQ0FBVyxZQUFYLEVBQXlCLE1BQU07QUFDN0J5QixJQUFBQSxVQUFVLENBQUMsTUFBTSxDQUFFLENBQVQsRUFBVyxVQUFYLENBQVY7QUFDRCxHQUZEO0FBR0EsU0FBT0YsU0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCBhc3NlcnQgZnJvbSAnYXNzZXJ0J1xuY29uc3QgbW9jaGFNb2R1bGUgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vZW50cnlwb2ludC9jbGkvaW5kZXguanMnKSAvLyBtb2NoYSBjbGkgZm9yIHJ1bm5pbmcgdXNpbmcgbm9kZWpzIHNwYXduIGNoaWxkIHByb2Nlc3MgaW50ZXJmYWNlIChhY2NlcHRpbmcgb25seSBtb2R1bGUgcGF0aHMpXG5pbXBvcnQgY2hpbGRQcm9jZXNzIGZyb20gJ2NoaWxkX3Byb2Nlc3MnXG5pbXBvcnQgeyBwcm9taXNlcyBhcyBmaWxlc3lzdGVtIH0gZnJvbSAnZnMnXG4vLyBhd2FpdCBmaWxlc3lzdGVtLmxzdGF0KGZpbGVQYXRoKS50aGVuKHN0YXRPYmplY3QgPT4gc3RhdE9iamVjdC5pc0RpcmVjdG9yeSgpKSAvLyBjaGVjayBpZiBwYXRoIGlzIGEgZGlyZWN0b3J5XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBydW5UZXN0KHtcbiAgdGFyZ2V0UHJvamVjdCA9IHRocm93IG5ldyBFcnJvcigndGFyZ2V0UHJvamVjdCBtdXN0IGJlIHBhc3NlZC4nKSwgLy8gYFByb2plY3QgY2xhc3NgIGluc3RhbmNlIGNyZWF0ZWQgYnkgYHNjcmlwdE1hbmFnZXJgIGZyb20gdGhlIGNvbmZpZ3VyYXRpb24gZmlsZSBvZiB0aGUgdGFyZ2V0IHByb2plY3QuXG4gIHNob3VsZENvbXBpbGVUZXN0LFxuICBzaG91bGREZWJ1Z2dlciA9IGZhbHNlLCAvLyBydW4gaXNwZWN0b3IgZHVyaW5nIHJ1bnRpbWUuXG4gIHRlc3RGaWxlQXJyYXksXG4gIGpzRmlsZUFycmF5LCAvLyB1c2VkIHRvIGNsZWFyIG5vZGVqcyBtb2R1bGUgY2FjaGUgb24gcmVzdGFydFxuICB3YXRjaEZpbGUgPSBmYWxzZSxcbn0gPSB7fSkge1xuICBjb25zb2xlLmxvZyhgXFx4MWJbMzNtXFx4MWJbMW1cXHgxYls3bVxceDFiWzM2bSVzXFx4MWJbMG0gXFx4MWJbMm1cXHgxYlszbSVzXFx4MWJbMG1gLCBgQ29udGFpbmVyOmAsIGBOb2RlSlMgQXBwYClcbiAgLy8gU2V0dXAgZW52aXJvbm1lbnRcbiAgYXdhaXQgcmVxdWlyZSgnQGRlcGVuZGVuY3kvYWRkTW9kdWxlUmVzb2x1dGlvblBhdGgnKS5hZGRNb2R1bGVSZXNvbHV0aW9uUGF0aCh7IHBhdGhBcnJheTogW3BhdGguZGlybmFtZShyZXF1aXJlLm1haW4uZmlsZW5hbWUpXSB9KVxuXG4gIGxldCBzdWJwcm9jZXNzIC8vIHN1YnByb2Nlc3MgcmVmZXJlbmNlIHRvIGNvbnRyb2wgdGVybWluYXRpb24uXG4gIC8vIG1ha2Ugc3VyZSB0aGF0IHBhcmVudCBwcm9jZXNzIHF1aXRpbmcgd2lsbCBhbHNvIGVuZCBzdWJwcm9jZXNzXG4gIHByb2Nlc3Mub24oJ1NJR0lOVCcsICgpID0+IHtcbiAgICBzdWJwcm9jZXNzICYmIHN1YnByb2Nlc3Mua2lsbCgnU0lHSU5UJylcbiAgICBjb25zb2xlLmxvZygnQ2F1Z2h0IGludGVycnVwdCBzaWduYWwnKSAmJiBwcm9jZXNzLmV4aXQoMClcbiAgfSlcbiAgZnVuY3Rpb24gcnVuTW9jaGFJblN1YnByb2Nlc3MoKSB7XG4gICAgbGV0IHN0cmluZ2lmeUFyZ3MgPSBKU09OLnN0cmluZ2lmeShbeyB0ZXN0VGFyZ2V0OiB0ZXN0RmlsZUFycmF5LCBqc0ZpbGVBcnJheSwgc2hvdWxkQ29tcGlsZVRlc3QsIHNob3VsZERlYnVnZ2VyLCB0YXJnZXRQcm9qZWN0IH1dKSAvLyBwYXJhbWV0cnMgZm9yIG1vY2hhIG1vZHVsZS5cbiAgICAvLyBydW5uaW5nIGluIHN1YnByb2Nlc3MgcHJldmVudHMgY29uZmxpY3RzIGJldHdlZW4gdGVzdHMgYW5kIGFsbG93cyB0byBjb250cm9sIHRoZSB0ZXN0IGFuZCB0ZXJtaW5hdGUgaXQgd2hlbiBuZWVkZWQuXG4gICAgc3VicHJvY2VzcyA9IGNoaWxkUHJvY2Vzcy5mb3JrKG1vY2hhTW9kdWxlLCBbc3RyaW5naWZ5QXJnc10sIHtcbiAgICAgIHN0ZGlvOiBbMCwgMSwgMiwgJ2lwYyddLFxuICAgICAgZXhlY0FyZ3Y6IFtcbiAgICAgICAgLy8gJy0taW5zcGVjdC1icms9MTI3MicsIC8vIGluc3BlY3Qgc3VicHJvY2VzcyB3aXRoIHJhbmRvbSBwb3J0IHRvIHByZXZlbnQgY29uZmxpY3RzIHdpdGggdGhlIG1haW4gcHJvY2VzcyBpbiBjYXNlIGl0J3MgaW5zcGVjdCBmbGFnIHdhcyB0dXJuZWQgb24uXG4gICAgICAgICctLW5vLWxhenknLCAvLyBmb3IgZGVidWdnaW5nIHB1cnBvc2VzIHdpbGwgbG9hZCBtb2R1bGVzIHNlcXVlbnRpYWxseVxuICAgICAgXSxcbiAgICB9KVxuICAgIHN1YnByb2Nlc3Mub24oJ2V4aXQnLCAoKSA9PiBjb25zb2xlLmxvZyhgVGVzdCBzdWJwcm9jZXNzICR7c3VicHJvY2Vzcy5waWR9IGV4aXRlZC5gKSlcbiAgfVxuXG4gIHJ1bk1vY2hhSW5TdWJwcm9jZXNzKCkgLy8gaW5pdGlhbCB0cmlnZ2VyIGFjdGlvbiwgdG8gcnVuIHRlc3QgaW1tZWRpYXRlbHlcblxuICAvLyByZXN0YXJ0IGZ1bmN0aW9uYWxpdHkgLSB0byBiZSBydW4gYWZ0ZXIgZmlsZSBub3RpZmljYXRpb25cbiAgZnVuY3Rpb24gcmVzdGFydE1vY2hhU3VicHJvY2VzcygpIHtcbiAgICBjb25zb2xlLmxvZygn4oCiIFRyaWdnZXJlZCBtb2NoYSB0ZXN0IHJlc3RhcnQgW2phdmFzY3JpcHRUZXN0UnVubmVyXScpXG4gICAgc3VicHJvY2VzcyAmJiBzdWJwcm9jZXNzLmtpbGwoJ1NJR0lOVCcpICYmIHJ1bk1vY2hhSW5TdWJwcm9jZXNzKClcbiAgfVxuXG4gIGlmICh3YXRjaEZpbGUpXG4gICAgYXdhaXQgd2F0Y2hGaWxlKHtcbiAgICAgIC8vIHRvIGJlIHJ1biBhZnRlciBmaWxlIG5vdGlmaWNhdGlvblxuICAgICAgdHJpZ2dlckNhbGxiYWNrOiByZXN0YXJ0TW9jaGFTdWJwcm9jZXNzLFxuICAgICAgLy8gVE9ETzogbWFrZSBzdXJlIGV4cGxpY2l0bHkgYWRkaW5nIGAuL25vZGVfbW9kdWxlcy9gIGludG8gdGhlIHRoaXMgYXJyYXksIHdpbGwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGlnbm9yZWQuXG4gICAgICBmaWxlQXJyYXk6IGpzRmlsZUFycmF5LFxuICAgICAgaWdub3JlTm9kZU1vZHVsZXM6IHRydWUsXG4gICAgICBsb2dNZXNzYWdlOiB0cnVlLFxuICAgIH0pXG5cbiAgLy8gcmV0dXJuIGZvciBleHRlcm5hbCB3YXRjaCBmaWxlcyB0byBjb250cm9sIHJlc3RhcnRcbiAgcmV0dXJuIHsgcmVzdGFydDogcmVzdGFydE1vY2hhU3VicHJvY2VzcyB9XG59XG5cbi8qKlxuICogQWxsb3dzIHRvIHVzZSBOb2RlanMgaW5zcGVjdG9yIHdpdGggdGhlIGN1cnJlbnQgd2F5IHRlc3RzIGFyZSBydW4sIHdoZXJlIHRlc3RzIGFyZSBydW4gaW4gc3VicHJvY2Vzc2VzIGFuZCBubyBOb2RlanMgZmxhZ3MgYXJlIHBhc3NlZC5cbiAqIEN1cnJlbnRseSBpdHMgcG9zc2libGUgdG8gdXNlIGluc3BlY3RvciBwcm9ncmFtbWF0aWMgQVBJLCBidXQgdG8gYWxsb3cgbGl2ZXJlbG9hZCBlYWNoIHRlc3Qgc3VicHJvY2VzcyBzaG91bGQgYmUga2VwdCBhbGl2ZSBlLmcuIHVzaW5nIGBzZXRUaW1lb3V0YCB0byBhbGxvdyBmb3IgaW5zcGVjdGluZyBvYmplY3QgdmFsdWVzIGV0Yy5cbiAqIFVzYWdlOlxuICogIC0gZXhlY3V0ZSB0aGlzIGZ1bmN0aW9uIGluIHRoZSB0b3Agb2YgYSB0ZXN0LlxuICogIC0gaW5zZXJ0IGBkZWJ1Z2dlcmAgc3RhdGVtZW50IGluIHRoZSB0ZXN0IGZpbGVzIHRvIGJyZWFrIGFmdGVyIHJlZnJlc2hpbmcgcHJvY2Vzcy5cbiAqXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzdWJwcm9jZXNzSW5zcGVjdG9yKHsgcG9ydCA9IDkyMjksIGhvc3QgPSAnbG9jYWxob3N0Jywgc2hvdWxkYnJlYWsgPSB0cnVlIH0gPSB7fSkge1xuICBjb25zdCBpbnNwZWN0b3IgPSByZXF1aXJlKCdpbnNwZWN0b3InKVxuICBpbnNwZWN0b3Iub3Blbihwb3J0LCBob3N0LCBzaG91bGRicmVhaylcbiAgLy8gS2VlcCBOb2RlIGFsaXZlIHRvIGFsbG93IGZvciBpbnNwZWN0aW5nIG9iamVjdHMuXG4gIHByb2Nlc3Mub24oJ2JlZm9yZUV4aXQnLCAoKSA9PiB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7fSwgMTAwMDAwMDAwMClcbiAgfSlcbiAgcmV0dXJuIGluc3BlY3RvclxufVxuIl19